<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
        <meta charset="UTF-8"/>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <title>Trafford Data Lab: Explore</title>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/css/labBase.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet/labLeafletMap.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet/extended_markers/extended_markers_base.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet/extended_markers/extended_markers_mixed.css"/>

        <style>
            .aboutContainer
            {
                margin-bottom: 10px;
            }

            .infoDockContainer
            {
                max-height: 250px;
            }

            .propertiesTable
            {
                width: 100%;
                font-size: 12px;
                background-color: rgba(240,240,240,0.5);
            }

            .propertiesTable td
            {
                vertical-align: top;
            }

            .propertiesTable td:nth-child(1)
            {
                font-weight: bold;
                width: 1%;
            }

            .datasetSelect
            {
                width: 100%;
            }

            @media (min-width:621px)
            {
                .mainPanelControl
                {
                    width: 280px;   /* desired width when not on mobiles */
                }
            }
        </style>
    </head>

    <body>
        <div id="map" class="mapFullScreen"></div>

        <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.62.0/dist/L.Control.Locate.min.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labError.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labAjax.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labGetQryStrValByKey.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labSpinner.js"></script>
        <script src="https://www.trafforddatalab.io/assets/leaflet/labCreateTileLayer.js"></script>
        <script src="https://www.trafforddatalab.io/assets/leaflet/labLeafletMap.js"></script>

        <script>
            // ######### FUNCTIONS #########
            // To setup each feature within GeoJSON
            function featureEvents (feature, layer) {
                // we need to discover the feature type - remember it is valid for this to be null!
                if (feature.hasOwnProperty('type')) {
                    featureType = feature.type.toLowerCase();

                    if (featureType == 'feature' || featureType == 'featurecollection') {
                        if (feature.hasOwnProperty('geometry') && feature.geometry.hasOwnProperty('type')) featureType = (feature.geometry.type !== null) ? feature.geometry.type.toLowerCase() : null;
                    }
                }

                // based on the feature type we now need to set the correct layer type
                if (featureType == 'point' && feature.hasOwnProperty('properties') && feature.properties.hasOwnProperty('featureRadius') && feature.properties.featureRadius !== '') {
                    layer.type = 'circle';  // special case as there is no circle in GeoJSON - therefore we can only distinguish between a circle and a point if we have a radius value
                }
                else if (featureType == 'point' || featureType == 'multipoint') {
                    layer.type = 'marker';
                }
                else if (featureType == 'polygon' || featureType == 'multipolygon') {
                    layer.type = 'polygon';
                }
                else if (featureType == 'linestring' || featureType == 'multilinestring') {
                    layer.type = 'polyline';
                }
                else {
                    layer.type = featureType;   // probably null
                }

                // Add handler to layer to show properties onclick
                layer.on({
                    click: showLayerProps
                });
            }

            // To setup any point data features within GeoJSON
            function pointData (feature, latlng) {
                if (feature.hasOwnProperty('properties') && feature.properties.hasOwnProperty('featureRadius') && feature.properties.featureRadius !== '') {
                    return L.circle(latlng, { radius: feature.properties.featureRadius });
                }
                else {
                    return L.marker(latlng, { icon: labMap.marker });
                }
            }

            // Reset the styling of a previously selected feature
            function resetFeatureStyle() {
                if (labMap.featureCache != null) {
                    if (labMap.featureCache.target.type == 'marker') {
                        labMap.featureCache.target.setIcon(labMap.marker);
                    }
                    else {
                        // work out if the feature is an overlay externally loaded layer or one of the geographies as the reset process is slightly different
                        if (labMap.overlayData != null && labMap.overlayData.hasLayer(labMap.featureCache.target)) {
                            labMap.overlayData.resetStyle(labMap.featureCache.target);
                        }
                        else {
                            labMap.featureCache.target.setStyle(labMap.poly);
                        }
                    }
                }
            }

            // Show the properties of a selected layer
            function showLayerProps(e) {
                L.DomEvent.stopPropagation(e);  // stop the event bubbling to the map which would cause the information to be removed from the info panel etc.

                var layer = e.target;
                var propsTable = '';

                // reset the style of a previously selected feature
                resetFeatureStyle();

                // set the highlight style of the selected feature
                if (layer.type == 'marker') {
                    layer.setIcon(labMap.markerSelected);
                }
                else {
                    layer.setStyle(labMap.polySelected);
                }

                // set new selected feature in the cache
                labMap.featureCache = e;

                // build the content for the properties table to be displayed
                if (layer.feature.hasOwnProperty('properties')) {
                    var props = layer.feature.properties;

                    for (var key in props) {
                        // ensure that the key is a valid property of the GeoJson object and isn't one of the styling options
                        if (props.hasOwnProperty(key) && key != 'stroke' && key != 'stroke-width' && key != 'stroke-opacity' && key != 'fill' && key != 'fill-opacity' && key != 'marker-color' && key != 'marker-size') {
                            propsTable += '<tr><td>' + key + '</td><td>';
                            propsTable += (props[key] == null) ? '' : props[key];
                            propsTable += '</td></tr>';
                        }
                    }

                    if (propsTable != '') labMap.updateInfo('<table class="propertiesTable">' + propsTable + '</table>');
                }
            }

            // This function is for styling non-point data. If it has internal styling properties use them, otherwise use a default
            function styleOverlayData(feature) {
                var styles = {
                    color: '#fc6721',
                    fillColor: '#fc6721',
                    opacity: 0.5,
                    fillOpacity: 0.2
                };

                var props = feature.properties;
                if (props != null) {
                    if (props['stroke'] != null) styles['color'] = props['stroke'];
                    if (props['stroke-width'] != null) styles['weight'] = props['stroke-width'];
                    if (props['stroke-opacity'] != null) styles['opacity'] = props['stroke-opacity'];
                    if (props['fill'] != null) styles['fillColor'] = props['fill'];
                    if (props['fill-opacity'] != null) styles['fillOpacity'] = props['fill-opacity'];
                }

                return styles;
            }

            // for loading data as an overlay layer
            function loadOverlayData(datasetKey) {
                // Remove any current data layer and reset the info panel
                if (labMap.overlayData !== null) labMap.overlayData.removeFrom(labMap.map);
                labMap.updateInfo();

                // Check to see if the dataset key we've been given matches any datset objects
                if (objDatasets.hasOwnProperty(datasetKey)) {
                    // Set the page title to match the dataset title.
                    document.title = 'Trafford Data Lab: ' + objDatasets[datasetKey].title;

                    // Update the about section
                    labMap.updateAbout(objDatasets[datasetKey].about);

                    startLabSpinner()  // inform the user that something is loading

                    // Attempt to load GeoJSON specified in the URL
                    labAjax(objDatasets[datasetKey].url, function (data) {
                        if (data !== null && data !== '') {
                            try {
                                // set the options for the GeoJSON layer
                                var layerOptions = { style: styleOverlayData, onEachFeature: featureEvents, pointToLayer: pointData, pane: 'pane_data_overlay' };
                                if (objDatasets[datasetKey].attribution !== null) layerOptions['attribution'] = 'data source: ' + objDatasets[datasetKey].attribution;

                                labMap.overlayData = L.geoJSON(data, layerOptions).addTo(labMap.map);
                            }
                            catch (e) {
                                labError(new LabException("Error attempting to create GeoJSON Leaflet layer: " + e.message));
                            }
                        }
                        else {
                            labError(new LabException("Couldn't find URL: " + objDatasets[datasetKey].url));
                        }

                        stopLabSpinner()   // remove the spinner as the data has loaded
                    });
                }
                else {
                    // No dataset found so reset the map to the initial state
                    document.title = 'Trafford Data Lab: ' + labMap.title
                    labMap.updateAbout(labMap.about);
                }
            }


            // ######### SETUP #########
            // list of datasets - add new ones to the end
            var objDatasets = {
                'agricultural_land': {
                    title: 'Agricultural land',
                    about: 'Five grades of agricultural land (1 = best quality to 5 = poorest quality) with classifications for urban and non-agricultural land in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/agricultural_land_classification/trafford_agricultural_land_classification.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/agricultural_land_classification" target="_blank">on GitHub</a>.',
                    attribution: 'Natural England',
                    url: 'https://www.trafforddatalab.io/open_data/agricultural_land_classification/trafford_agricultural_land_classification_styled.geojson',
                    theme: 'Environment'
                },
                'air_quality': {
                    title: 'Air quality',
                    about: 'Air Quality Management Areas (AQMAs) in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/AQMA/trafford_aqma.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/AQMA" target="_blank">on GitHub</a>.',
                    attribution: 'Department for Environment Food & Rural Affairs (Defra)',
                    url: 'https://www.trafforddatalab.io/open_data/AQMA/trafford_aqma_styled.geojson',
                    theme: 'Environment'
                },
                'betting_shops': {
                    title: 'Betting shops',
                    about: 'Premises licence data for Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/betting_shops/bettingshops_trafford.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/betting_shops/bettingshops_trafford.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/betting_shops" target="_blank">on GitHub</a>.',
                    attribution: 'Gambling Commission',
                    url: 'https://www.trafforddatalab.io/open_data/betting_shops/bettingshops_trafford.geojson',
                    theme: 'Licenced premises'
                },
                'buildings': {
                    title: 'Buildings',
                    about: 'Buildings in Trafford derived from Ordnance Survey\'s OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/buildings/trafford_buildings.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/buildings" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/buildings/trafford_buildings_styled.geojson',
                    theme: 'Housing'
                },
                'care_homes': {
                    title: 'Care homes',
                    about: 'Nursing and residential care homes in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/care_homes/trafford_care_homes.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/care_homes/trafford_care_homes.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/care_homes" target="_blank">on GitHub</a>.',
                    attribution: 'Care Quality Commission',
                    url: 'https://www.trafforddatalab.io/open_data/care_homes/trafford_care_homes.geojson',
                    theme: 'Health'
                },
                'cctv': {
                    title: 'CCTV',
                    about: 'Locations of Local Authority controlled CCTV cameras in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/cctv/CCTV_cameras_trafford.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/cctv/CCTV_cameras_trafford.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/cctv" target="_blank">on GitHub</a>.',
                    attribution: 'Trafford Council',
                    url: 'https://www.trafforddatalab.io/open_data/cctv/CCTV_cameras_trafford.geojson',
                    theme: 'Community Safety'
                },
                'defibrillators': {
                    title: 'Defibrillators',
                    about: 'Defibrillator locations within Trafford. Please note that there may be restrictions on access and availability and locations are approximate.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/defibrillators/trafford_defibrillators.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/defibrillators/trafford_defibrillators.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/defibrillators" target="_blank">on GitHub</a>.',
                    attribution: 'Trafford Council',
                    url: 'https://www.trafforddatalab.io/open_data/defibrillators/trafford_defibrillators.geojson',
                    theme: 'Health'
                },
                'further_education_colleges': {
                    title: 'Further education colleges',
                    about: 'Further education colleges in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/education/further/trafford_further_education.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/education/further" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/education/further/trafford_further_education_styled.geojson',
                    theme: 'Education'
                },
                'primary_schools': {
                    title: 'Primary schools',
                    about: 'Primary schools in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/education/primary/trafford_primary_schools.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/education/primary" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/education/primary/trafford_primary_schools_styled.geojson',
                    theme: 'Education'
                },
                'secondary_schools': {
                    title: 'Secondary schools',
                    about: 'Secondary schools in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/education/secondary/trafford_secondary_schools.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/education/secondary" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/education/secondary/trafford_secondary_schools_styled.geojson',
                    theme: 'Education'
                },
                'special_schools': {
                    title: 'Special schools',
                    about: 'Special schools in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/education/special/trafford_special_schools.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/education/special" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/education/special/trafford_special_schools_styled.geojson',
                    theme: 'Education'
                },
                'electric_car_charging_points': {
                    title: 'Electric car charging points',
                    about: 'Electric car charging points in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/car_charging_points/trafford_car_charging_points.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/car_charging_points/trafford_car_charging_points.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/car_charging_points" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/car_charging_points/trafford_car_charging_points.geojson',
                    theme: 'Transport'
                },
                'fire_stations': {
                    title: 'Fire stations',
                    about: 'Fire stations in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/fire_stations/trafford_fire_stations.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/fire_stations" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/fire_stations/trafford_fire_stations_styled.geojson',
                    theme: 'Community Safety'
                },
                'flood_risk': {
                    title: 'Flood risk',
                    about: 'The dataset shows the chance of flooding from rivers and/or the sea, based on 50m cells in Trafford. Each cell is allocated to one of four flood risk categories, taking into account flood defences and their condition.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/flood_risk/trafford_flood_risk.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/flood_risk" target="_blank">on GitHub</a>.',
                    attribution: 'Environment Agency',
                    url: 'https://www.trafforddatalab.io/open_data/flood_risk/trafford_flood_risk_styled.geojson',
                    theme: 'Environment'
                },
                'food_banks': {
                    title: 'Food banks',
                    about: 'Location of food banks, pantries and food clubs across Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/food_banks/trafford_food_banks.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/food_banks/trafford_food_banks.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/food_banks" target="_blank">on GitHub</a>.',
                    attribution: 'GM Poverty Action',
                    url: 'https://www.trafforddatalab.io/open_data/food_banks/trafford_food_banks.geojson',
                    theme: 'Labour Market'
                },
                'general_practices': {
                    title: 'General practices',
                    about: 'General practice (GP) locations in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/general_practice/trafford_general_practices.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/general_practice/trafford_general_practices.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/general_practice" target="_blank">on GitHub</a>.',
                    attribution: 'Care Quality Commission',
                    url: 'https://www.trafforddatalab.io/open_data/general_practice/trafford_general_practices.geojson',
                    theme: 'Health'
                },
                'green_spaces': {
                    title: 'Green spaces',
                    about: 'Parks, playing fields, gardens and other green spaces that are likely to be publicly accessible in Trafford.<br /><br />Please also see our <a href="https://www.trafforddatalab.io/maps/greenspace/">enhanced version</a> of this map for more details.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/greenspaces/trafford_greenspace_sites.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/greenspaces" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/greenspaces/trafford_greenspace_sites_styled.geojson',
                    theme: 'Environment'
                },
                'hospitals': {
                    title: 'Hospitals',
                    about: 'Hospitals in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/hospitals/trafford_hospitals.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/hospitals" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/hospitals/trafford_hospitals_styled.geojson',
                    theme: 'Health'
                },
                'jobcentre_plus': {
                    title: 'Jobcentre Plus',
                    about: 'Jobcentre Plus offices in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/job_centre_plus/jobcentreplus_trafford_trafford.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/job_centre_plus/jobcentreplus_trafford.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/job_centre_plus" target="_blank">on GitHub</a>.',
                    attribution: 'Department for Work and Pensions',
                    url: 'https://www.trafforddatalab.io/open_data/job_centre_plus/jobcentreplus_trafford.geojson',
                    theme: 'Labour Market'
                },
                'listed_buildings': {
                    title: 'Listed buildings',
                    about: 'Listed buildings in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/listed_buildings/trafford_listed_buildings.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/listed_buildings/trafford_listed_buildings.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/listed_buildings" target="_blank">on GitHub</a>.',
                    attribution: 'Historic England (English Heritage)',
                    url: 'https://www.trafforddatalab.io/open_data/listed_buildings/trafford_listed_buildings.geojson',
                    theme: 'Historical Interest'
                },
                'metrolink_stops': {
                    title: 'Metrolink stops',
                    about: 'Metrolink stops in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/transport/metrolink/stops/trafford_metrolink_stops.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/transport/metrolink/stops/trafford_metrolink_stops.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/transport/metrolink/stops" target="_blank">on GitHub</a>.',
                    attribution: 'Transport for Greater Manchester',
                    url: 'https://www.trafforddatalab.io/open_data/transport/metrolink/stops/trafford_metrolink_stops.geojson',
                    theme: 'Transport'
                },
                'motorway_junctions': {
                    title: 'Motorway junctions',
                    about: 'Motorway junctions in Trafford from OS Open Roads.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/open_roads/trafford_motorwayJunction.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/open_roads" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/open_roads/trafford_motorwayJunction.geojson',
                    theme: 'Transport'
                },
                'open_plaques': {
                    title: 'Open plaques',
                    about: 'Inscriptions on and locations of commemorative plaques in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/open_plaques/open_plaques_trafford.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/open_plaques/open_plaques_trafford.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/open_plaques" target="_blank">on GitHub</a>.',
                    attribution: 'Data gathered by Open Plaques',
                    url: 'https://www.trafforddatalab.io/open_data/open_plaques/open_plaques_trafford.geojson',
                    theme: 'Historical Interest'
                },
                'pharmacies': {
                    title: 'Pharmacies',
                    about: 'Locations of pharmacies in Trafford.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/pharmacies/trafford_pharmacies.csv" target="_blank">CSV</a> | <a href="https://www.trafforddatalab.io/open_data/pharmacies/trafford_pharmacies.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/pharmacies" target="_blank">on GitHub</a>.',
                    attribution: 'Trafford Council',
                    url: 'https://www.trafforddatalab.io/open_data/pharmacies/trafford_pharmacies.geojson',
                    theme: 'Health'
                },
                'roads': {
                    title: 'Roads',
                    about: 'Road links in Trafford from OS Open Roads.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/open_roads/trafford_roadLink.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/open_roads" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/open_roads/trafford_roadLink_styled.geojson',
                    theme: 'Transport'
                },
                'terrain_contours': {
                    title: 'Terrain contours',
                    about: '10m contours constrained by the boundary of Trafford borough from OS Terrain 50.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/terrain/trafford_terrain_lines.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/terrain" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/terrain/trafford_terrain_lines_styled.geojson',
                    theme: 'Environment'
                },
                'terrain_spot_heights': {
                    title: 'Terrain spot heights',
                    about: 'Spot heights constrained by the boundary of Trafford borough from OS Terrain 50.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/terrain/trafford_terrain_points.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/terrain" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/terrain/trafford_terrain_points.geojson',
                    theme: 'Environment'
                },
                'watercourses': {
                    title: 'Watercourses',
                    about: 'Rivers and other waterways constrained by the boundary of Trafford borough from OS Open Rivers.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/watercourses/trafford_watercourses.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/watercourses" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/watercourses/trafford_watercourses_styled.geojson',
                    theme: 'Environment'
                },
                'woodland': {
                    title: 'Woodland',
                    about: 'Woodland in Trafford from OS OpenMap - Local.<br /><br />Download: <a href="https://www.trafforddatalab.io/open_data/woodland/trafford_woodland.geojson" target="_blank">GeoJSON</a>.<br />Further resources available <a href="https://github.com/traffordDataLab/open_data/tree/master/woodland" target="_blank">on GitHub</a>.',
                    attribution: 'Ordnance Survey',
                    url: 'https://www.trafforddatalab.io/open_data/woodland/trafford_woodland_styled.geojson',
                    theme: 'Environment'
                }

                /* Add new datasets using the contruct below:
                '': {
                    title: '',
                    about: '',
                    attribution: '',
                    url: '',
                    theme: ''
                }
                */
            }

            var arrSelectList = [];     // array to hold the contents of the select list to choose the dataset to visualise

            // Loop through the objDatasets object adding the main key, title and theme to the array
            for (key in objDatasets) {
                if (objDatasets.hasOwnProperty(key)) {
                    arrSelectList.push({ dataset: key, title: objDatasets[key].title, theme: objDatasets[key].theme });
                }
            }

            // Sort the select list array by the themes first as these form the optgroup headings, then by the dataset titles
            arrSelectList.sort(function(a, b) {
                var themeA = a.theme.toLowerCase();
                var themeB = b.theme.toLowerCase();
                var titleA = a.title.toLowerCase();
                var titleB = b.title.toLowerCase();

                // attempt sorting by theme first
                if (themeA < themeB) return -1;
                if (themeA > themeB) return 1;

                // if the theme is the same, sort by the title
                if (titleA < titleB) return -1;
                if (titleA > titleB) return 1;
                return 0;
            });

            // Check the URL for a dataset key in the Query String
            var datasetQS = labGetQryStrValByKey('dataset');

            // Create the select element to choose the objDatasets
            var datasetSelect = '<select name="frmDatasetList" onChange="loadOverlayData(this.value)" class="datasetSelect"><option value="" selected="selected">Select a dataset to visualise...</option>';

            var optGroupTheme = '';     // ensure we create new optgroup tags based on the themes

            for (var i = 0; i < arrSelectList.length; i++) {
                // Write out new optgroup tag
                if (optGroupTheme != arrSelectList[i].theme) {
                    if (optGroupTheme != '') datasetSelect += '</optgroup>';
                    datasetSelect += '<optgroup label="' + arrSelectList[i].theme + '">';
                    optGroupTheme = arrSelectList[i].theme;
                }

                // Write out the objDatasets
                datasetSelect += '<option value="' + arrSelectList[i].dataset + '"';
                if (datasetQS == arrSelectList[i].dataset) datasetSelect += ' selected="selected"';
                datasetSelect += '>' + arrSelectList[i].title + '</option>';
            }

            datasetSelect += '</optgroup></select>';


            // ######### INITIALISATION #########
            var labMap = new LabLeafletMap({
                title: 'Explore',
                about: 'Discover the different geographies within Trafford by choosing a layer and then selecting an area.',
                filterGUI: datasetSelect
            });

            labMap.baseLayers['Low detail'].addTo(labMap.map);   // Choose the base/tile layer for the map
            labMap.overlayData = null;  // object to store overlay data
            labMap.featureCache = null; // for caching the feature currently selected

            // Polygon feature styling
            labMap.poly = {
                color: '#212121',
                weight: 2,
                fillOpacity: 0
            };

            // Selected polygon styling
            labMap.polySelected = {
                color: '#ffea00',
                weight: 3,
                fillColor: '#ffff00',
                fillOpacity: '0.5',
                opacity: '1'
            };

            // Point data feature styling
            labMap.marker = L.AwesomeMarkers.icon({
                markerColor: 'pin-circle-orange-bright',
                iconSize: [20, 39]
            });

            // User-selected point data styling
            labMap.markerSelected = L.AwesomeMarkers.icon({
                markerColor: 'pin-circle-yellow-bright',
                iconSize: [20, 39]
            });

            // Check if there is a dataset to load via the Query String
            if (datasetQS !== null) loadOverlayData(datasetQS);


            // ######### EVENTS #########
            // Reset the map state if any features have been selected
            labMap.map.on('click', (function (e) {
                resetFeatureStyle();    // reset the style of a previously selected feature
                labMap.updateInfo();    // clear and hide the info panel
            }));


            // ######### LOAD SPATIAL GEOGRAPHY LAYERS/LABELS #########
            // Add the Trafford boundary
            labAjax('https://www.trafforddatalab.io/spatial_data/local_authority/2016/trafford_local_authority_full_resolution.geojson', function (data) {
                labMap.boundaryLA = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents }).addTo(labMap.map);
                labMap.map.fitBounds(labMap.boundaryLA.getBounds()); // adjust the zoom to fit the boundary to the screen size

                labMap.overlayLayers['1. Local authority'] = labMap.boundaryLA;
                labMap.updateLayerControl();
            });

            // Add the Trafford wards
            labAjax('https://www.trafforddatalab.io/spatial_data/ward/2017/trafford_ward_full_resolution.geojson', function (data) {
                labMap.boundaryWards = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['2. Wards'] = labMap.boundaryWards;
                labMap.updateLayerControl();
            });

            // Add the Trafford MSOAs
            labAjax('https://www.trafforddatalab.io/spatial_data/msoa/2011/trafford_msoa_full_resolution.geojson', function (data) {
                labMap.boundaryMSOAs = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['3. MSOA'] = labMap.boundaryMSOAs;
                labMap.updateLayerControl();
            });

            // Add the Trafford LSOAs
            labAjax('https://www.trafforddatalab.io/spatial_data/lsoa/2011/trafford_lsoa_full_resolution.geojson', function (data) {
                labMap.boundaryLSOAs = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['4. LSOA'] = labMap.boundaryLSOAs;
                labMap.updateLayerControl();
            });

            // Add the Trafford OAs
            labAjax('https://www.trafforddatalab.io/spatial_data/oa/2011/trafford_oa_generalised.geojson', function (data) {
                labMap.boundaryOAs = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['5. OA'] = labMap.boundaryOAs;
                labMap.updateLayerControl();
            });

            // Add the Trafford localities
            labAjax('https://www.trafforddatalab.io/spatial_data/council_defined/trafford_localities.geojson', function (data) {
                labMap.boundaryLocalities = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['6. Localities'] = labMap.boundaryLocalities;
                labMap.updateLayerControl();
            });

            // Add labels for the town centres
            labAjax('https://www.trafforddatalab.io/spatial_data/town_centres/trafford_town_centres.geojson', function (data) {

                labMap.townCentres = L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, { icon: L.divIcon({ iconSize: null }) }).bindTooltip(feature.properties.name, { direction: 'center', className: 'labLabels', opacity: 1, permanent: true });
                    }
                });

                labMap.overlayLayers['7. Town centres'] = labMap.townCentres;
                labMap.updateLayerControl();
            });
        </script>
    </body>
</html>
